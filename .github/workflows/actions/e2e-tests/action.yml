name: 'E2E Tests'
description: 'Run end-to-end tests with Cypress'

inputs:
  database-url:
    description: 'Database connection URL'
    required: true
  better-auth-secret:
    description: 'Better Auth secret key'
    required: true
  better-auth-url:
    description: 'Better Auth URL'
    required: false
    default: 'http://localhost:3000'
  better-auth-trusted-origins:
    description: 'Better Auth trusted origins'
    required: false
    default: 'http://localhost:3000,http://127.0.0.1:3000'
  resend-api-key:
    description: 'Resend API key'
    required: true
  base-url:
    description: 'Base URL for the application'
    required: false
    default: 'http://localhost:3000'
  prod-base-url:
    description: 'Production base URL'
    required: true
  test-email:
    description: 'Test user email'
    required: true
  test-password:
    description: 'Test user password'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Install Cypress
      shell: bash
      run: pnpm add cypress --save-dev && pnpm cypress install

    - name: Run E2E Tests
      shell: bash
      env:
        DATABASE_URL: ${{ inputs.database-url }}
        BETTER_AUTH_SECRET: ${{ inputs.better-auth-secret }}
        BETTER_AUTH_URL: ${{ inputs.better-auth-url }}
        BETTER_AUTH_TRUSTED_ORIGINS: ${{ inputs.better-auth-trusted-origins }}
        RESEND_API_KEY: ${{ inputs.resend-api-key }}
        BASE_URL: ${{ inputs.base-url }}
        PROD_BASE_URL: ${{ inputs.prod-base-url }}
        TEST_EMAIL: ${{ inputs.test-email }}
        TEST_PASSWORD: ${{ inputs.test-password }}
      run: pnpm dlx start-server-and-test "pnpm dev" http://localhost:3000 "pnpm cypress run --browser chrome"

    - name: Upload Cypress Videos and Screenshots on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-artifacts
        path: |
          cypress/videos
          cypress/screenshots